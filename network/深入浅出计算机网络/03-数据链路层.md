## 概述

- 链路(Link)是指从一个节点到相邻节点的一段物理线路（有线或无线），而中间没有任何其他的交换节点。
- 数据链路(Data Link)是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，就构成了数据链路
- 计算机中的网络适配器（俗称网卡）和其相应的软件驱动程序就实现了这些协议。一般的网络适配器都包含了物理层和数据链路层这两层的功能。
- 帧（Frame）是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元PDU

## 数据链路层的三个重要问题

- 封装成帧和透明传输
  - 数据链路层给上层交付下来的协议数据单元PDU添加帧首部和帧尾部，这称为封装成帧
  - 如果能够采取措施，使得数据链路层对上层交付的PDU的内容没有任何限制，就好像数据链路层不存在一样，就称为透明传输
- 差错检测
  - 帧在传输的过程中可能出现误码
  - 接收方根据发送方添加在帧尾部中的检错码，可以检测出帧是否出现了误码
- 可靠传输
  - 不可靠传输服务：收到有误码的帧，直接丢弃，其他什么都不要做；未收到发送方发送的帧，也不进行任何处理
  - 可靠传输服务：实现发送方发送什么，接收方最终都能正确收到。

## 封装成帧

- 封装成帧是指数据链路层给上层交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧。

  - 帧的首部和尾部包含有一些重要的控制信息
  - 帧首部和尾部的作用之一就是帧定界（并不是每一种数据链路层协议的帧都包含有帧定界标志）

  <table>
    <tr>
      <td colspan="7" align="center">点对点协议的PPP帧</td>
    </tr>
    <tr>
      <td>1B</td>
      <td>2B</td>
      <td>最大1500B</td>
      <td>2B</td>
      <td>1B</td>
      <td>1B</td>
      <td>1B</td>
    </tr>
    <tr>
    	<td>标志</td>
      <td>FCS</td>
      <td>数据载荷</td>
      <td>协议</td>
      <td>控制</td>
      <td>地址</td>
      <td>标志</td>
    </tr>
  </table>

  <table>
    <tr>
    	<td colspan="7" align="center">以太网V2的MAC帧（最大长度1518B;帧首部和尾部没有帧定界标志）</td>
    </tr>
    <tr>
    	<td>4B</td>
      <td>46-1500B</td>
      <td>2B</td>
      <td>6B</td>
      <td>6B</td>
    </tr>
    <tr>
    	<td>FCS</td>
      <td>数据载荷</td>
      <td>类型</td>
      <td>源地址</td>
      <td>目的地址</td>
    </tr>
  </table>

  - 以太网V2的MAC帧会在物理层添加前导码，帧间间隔（发送96比特所耗费的时间）

  ![](./images/帧.jpg)

- 为了提高数据链路层传输帧的效率，应当使帧的数据载荷的长度尽可能地大于首部和尾部的长度
- 考虑到对缓存空间的需要以及差错控制等诸多因素，每一种数据链路层协议都规定了帧的数据载荷的长度上限，即最大传送单元(Maximum Transfer Unit, MTU),例如，以太网的MTU为1500个字节

## 透明传输

- 透明传输是指数据链路层对上层交付下来的协议数据单元PDU没有任何限制，就好像数据链路层不存在一样。

  - 面向字节的物理链路使用字节填充的方法实现透明传输
  - 面向比特的物理链路使用比特填充的方法实现透明传输

- HDLC协议对0111 1100 0111 1110组成帧后对应的比特串为：0111 1100 0011 1110 10

  - 高级数据链路控制协议HDLC采用帧首部和帧尾部中的标志字段作为帧定界符，其值为01111110.HDLC为了实现透明传输，采用零比特填充法，即每5个连续比特1后面插入一个比特0

- 在某个数据链路层协议中使用下列字符编码

  - A:01000111  B:11100011  ESC:11100000  FLAG:01111110
  - 其中帧的数据载荷为4个字符A， B, ESC以及FLAG，请分别使用字符填充法和零比特填充法将其封装成帧

  <table>
    <tr>
    	<td colspan="8" align="center">字符填充法封装成帧</td>
    </tr>
    <tr>
    	<td>帧定界符</td>
      <td colspan="6" align="center">帧的数据载荷</td>
      <td>帧定界符</td>
    </tr>
    <tr>
    	<td>FLAG</td>
      <td>A</td>
      <td>B</td>
      <td>转义ESC</td>
      <td>ESC</td>
      <td>转义ESC</td>
      <td>FLAG</td>
      <td>FLAG</td>
    </tr>
    <tr>
    	<td>01111110</td>
      <td>01000111</td>
      <td>11100011</td>
      <td>11100000</td>
      <td>11100000</td>
      <td>11100000</td>
      <td>01111110</td>
      <td>01111110</td>
    </tr>
  </table>

  <table>
    <tr>
    	<td colspan="6" align="center">零比特填充法封装成帧</td>
    </tr>
    <tr>
    	<td>帧定界符</td>
      <td colspan="4" align="center">帧的数据载荷</td>
      <td>帧定界符</td>
    </tr>
    <tr>
    	<td>FLAG</td>
      <td>A</td>
      <td>B</td>
      <td>ESC</td>
      <td>FLAG</td>
      <td>FLAG</td>
    </tr>
    <tr>
    	<td>01111110</td>
      <td>01000111</td>
      <td>11(0)100011</td>
      <td>111(0)00000</td>
      <td>011111(0)10</td>
      <td>01111110</td>
    </tr>
  </table>

## 差错检测

### 误码的相关概念

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错（称为比特差错）
  - 比特1可能变成比特0
  - 比特0可能变成比特1
- 在一段时间内，传输错误的比特数量占所传输比特总数的比率称为误码率(Bit Error Rate, BER)
- 提高链路的信噪比，可以降低误码率。但在实际的通信链路上，不可能使误码率下降为零
- 使用差错检测技术来检测数据再传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一
- 以太网V2的MAC帧根据帧尾中的检错码检测帧中是否有误码

### 奇偶校验

- 奇校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中比特1的个数为奇数
- 偶校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中比特1的个数为偶数

### 循环冗余校验

![](./images/循环冗余校验发送端.jpg)

![](./images/循环冗余校验接收端.jpg)

- 奇偶校验，循环冗余校验等差错检测技术，只能检测出传输过程中出现了差错，但并不能定位错误，因此无法纠正错误
- 要想纠正传输中的差错，可以使用冗余信息更多的纠错码（例如海明码）进行前向纠错。但纠错码的开销比较大，在计算机网络中较少使用
- 在计算机网络中，通常采用我们后续课程中将要介绍的检错重传方式来纠正传输中的差错，或者仅仅丢弃检测到差错的帧，这取决于数据链路层向上层提供的是可靠传输服务还是不可靠传输服务
- 循环冗余校验CRC具有很好的检错能力（漏检率极低），虽然计算比较复杂，但非常易于硬件实现，因此被广泛应用于数据链路层。