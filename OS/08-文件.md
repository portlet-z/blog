## 初识文件管理

#### 文件的属性

- 文件名：由创建文件的用户决定文件名，主要是危露方便用户找到文件，同一目录下不允许有重名文件
- 标识符：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称
- 类型：指明文件的类型
- 位置：文件存放的路径（让用户使用）、在外存中的地址（操作系统使用，对用户不可见）
- 大小：指明文件大小
- 创建时间，修改时间
- 文件所有者信息
- 保护信息：对文件进行保护的访问控制信息

#### 文件内部的数据应该怎样组织起来

- 无结构文件（如文本文件）-- 由一些二进制或字符流组成，又称”流式文件“
- 有结构文件（如数据库表） -- 由一组相似的记录组成，又称”记录式文件“
  - 数据项是文件系统中最基本的单位
  - 记录是一组相关数据项的集合
  - 有结构文件中，各个记录间应该如何组织的问题--应该顺序存放？还是用索引表来表示记录间的顺序？这是”文件的逻辑结构“重点要探讨的问题

#### 操作系统应该向上提供哪些功能

- 创建文件(create系统调用)
- 删除文件(delete系统调用)
- 读文件(read系统调用)
- 写文件(write系统调用)
- 打开文件(open系统调用)
- 关闭文件(close系统调用)

#### 从上往下看，文件应如何存放在外存

- 操作系统以块为单位为文件分配存储空间，因此即使一个文件大小只有10B,但它依然需要占用1KB的磁盘块(假设块大小为1KB)。外存中的数据读入内存同样以块为单位
- 类似于内存分为一个个内存块，外存会分为一个个”块/磁盘/物理块“。每个磁盘块的大小是相等的，每块一般包含2的整数幂个地址。同样类似的是，文件的逻辑地址也可以分为（逻辑块号，块内地址），操作系统同样需要将逻辑地址转换为外存的物理地址（物理块号，块内地址）的形式。块内地址的位数取决于磁盘块的大小
- 与内存单元一样，外存也是又一个个存储单元组成的，每个存储单元可以存储一定量的数据。每个存储单元对应一个物理地址



## 结构文件

#### 顺序文件

- 串结构：记录顺序与关键字无关
- 顺序结构：记录按关键字排列
- 可变长记录的顺序文件无法实现随机存取，定长记录可以
- 定长记录、顺序结构的顺序文件可以快速检索（根据关键字快速找到记录）
- 最大缺点：不方便增加、删除记录

#### 索引文件

- 建立一张索引表，每个记录对应一个表项。各记录不用保持顺序，方便增加、删除记录
- 索引表本身就是定长记录的顺序文件，一个索引表项就是一条定长记录，因此索引文件可支持随机存取
- 若索引表按关键字排列，则可支持快速检索
- 解决了顺序文件不方便增、删记录的问题，同时让不定长记录的文件实现了随机存取。但索引表可能占用很多空间

#### 索引顺序文件

- 将记录分组，每组对应一个索引表项
- 检索记录时先顺序查索引表，找到分组，再顺序查找分组
- 当记录过多时，可建立多级索引表



## 文件目录

#### 文件目录的实现

- 一个文件对应一个FCB,一个FCB就是一个目录项，多个FCB组成文件目录
- 对目录的操作：搜索，创建文件，删除文件，显示文件，修改文件

#### 目录结构

- 单级目录结构：一个系统只有一张目录表，不允许文件重名
- 两级目录结构：不同用户的文件可以重名，但不能对文件进行分类
- 多级（树形）目录结构
  - 不同目录下的文件可以重名，可以对文件进行分类，不方便文件共享
  - 系统根据”文件路径“找到目标文件
  - 从根目录出发的路径是”绝对路径“
  - 从”当前目录“出发的是路径是”相对路径“
- 无环图目录结构
  - 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图
  - 为共享结点设置一个共享计数器，计数器为0时才真正删除该节点

#### 索引结点

- 除了文件名之外的所有信息都放到索引结点中，每个文件对应一个索引结点
- 目录项中只包含文件名、索引结点指针，因此每个目录项的长度大幅减少
- 由于目录项长度减少，因此每个磁盘块可以存放更多个目录项，因此检索文件时磁盘IO的次数就少了很多



## 文件分配方式

#### 文件块、磁盘块

- 类似于内存分页，磁盘中的存储单元也会被分为一个个”块、磁盘块、物理块“。很多操作系统中，磁盘块的大小与内存块、页面的大小相同
- 内存与磁盘之间的数据交换（即读写操作、磁盘IO）都是以”块“为单位进行的。即每次读入一块，或每次写入一块
- 在内存管理中，进程的逻辑地址空间被分为一个一个页面。同样的，在外存管理中，为了方便对文件数据的管理，文件的逻辑地址空间被分为了一个一个的文件”块“。于是文件的逻辑地址也可以表示为（逻辑块号，块内地址）的形式
- 操作系统为文件分配存储空间都是以块为单位的
- 用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射

#### 连续分配

- 连续分配方式要求每个文件再磁盘上占有一组连续的块
- 优点：支持顺序访问和直接访问（即随机访问）；连续分配的文件再顺序访问上时速度最快
- 缺点：不方便文件扩展；存储空间利用率低，会产生磁盘碎片

#### 链接分配-隐式链接

- 目录中记录了文件存放的起始块号和结束块号。当然，也可以增加一个字段来表示文件的长度
- 除了文件最后一个磁盘块之外，每个磁盘块中都会保存下一个盘块的指针，这些指针对用户是透明的。文件目录包括文件第一块的指针和最后一块指针
- 优点：很方便文件拓展，不会有碎片问题，外存利用率高
- 缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要消耗少量的存储空间

#### 链接分配-显示链接

- 把用于链接文件各物理块的指针显示的存放在一张表中。即文件分配表（FAT, File Allocation Table）
- 注意：一个磁盘仅设置一张FAT。开机时，将FAT读入内存，并常驻内存。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此”物理块号“字段可以是隐含的
- 优点：很方便文件拓展，不会有碎片问题，外存利用率高，并且支持随机访问。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件的访问效率更高
- 缺点：文件分配表需要占用一定的存储空间

#### 索引分配

- 

