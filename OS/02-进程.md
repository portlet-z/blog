## 定义、组成、组织方式、特征

#### 定义

- 系统为每个运行的程序配置一个数据结构，称为进程控制块(PCB)，用来描述进程的各种信息（如程序代码存放位置）
- 程序段、数据段、PCB三部分组成了进程实体（进程映像）。一般情况下，我们把进程实体就简称为进程，例如，所谓创建进程实质上是创建进程实体中的PCB；而撤销进程，实质上是撤销进程实体中的PCB
- 传统的定义
  - 进程是程序的一次执行过程
  - 进程是一个程序及其数据再处理机上顺序执行时所发生的活动
  - 进程是具有独立功能的程序在数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位
  - 强调动态性
- 引入进程实体概念后，可把进程定义为：进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位，强调静态性

#### 组成

- 进程（进程实体）由程序段、数据段、PCB三部分组成
- 操作系统通过PCB来管理进程，因此PCB中应该包括操作系统对其进行管理所需的各种信息
- 程序代码存放在程序段
- 数据段存放程序运行时使用、产生的运算数据。如全局变量、局部变量、宏定义的常量
- PCB：进程的管理者（操作系统）所需的数据都在PCB中
  - 进程描述信息：进程标识符PID(当进程被创建时，操作系统会为该进程分配一个唯一的、不重复的ID,用于区分不同的进程)；用户标识符UID
  - 进程控制和管理信息：进程当前状态；进程优先级
  - 资源分配清单：程序段指针；数据段指针；键盘；鼠标
  - 处理机相关信息：各种寄存器值，当进程切换时需要把进程当前的运行情况记录下来保存在PCB中，如程序计数器的值表示了当前程序执行到了哪一句
- 程序本身的运行所需的数据都存放在程序段和数据段

#### 组织

- 在一个系统中，通常有数十、数百乃至数千个PCB。为了能对他们加以有效的管理，应该用适当的方式把这些PCB组织起来。进程的组成讨论的是一个进程内部由哪些部分构成的问题，而进程的组织讨论的是多个进程之间的组织方式问题
- [链接方式](http://assets.processon.com/chart_image/61f360de1e08530f01574b33.png)
  - 按照进程状态将PCB分为多个队列
  - 操作系统持有指向各个队列的指针
- [索引方式](http://assets.processon.com/chart_image/61f364517d9c0806abaab4f0.png)
  - 根据进程状态的不同，建立几张索引表
  - 操作系统持有指向各个索引表的指针

#### 特征

- 动态性：进程是程序一次执行过程，是动态地产生、变化和消亡的。动态性是进程最基本的特征
- 并发性：内存中有多个进程实体，各进程可并发执行
- 独立性：进程是能独立运行、独立获得资源、独立接受调度的基本单位。进程是资源分配、接受调度的基本单位
- 异步性：各进程按各自独立的、不可预知的速度向前推进，操作系统要提供”进程同步机制“来解决异步问题。异步性会导致并发程序执行结果的不确定性。
- 结构性：每个进程都会配置一个PCB。结构上看，进程由程序段、数据段、PCB组成



## 进程的状态与转换

#### 进程的5种状态

- 三种基本状态
  - 运行态(Running):占有CPU,并在CPU上运行。单核处理机环境下，每一个时刻最多只有一个进程处于运行态。双核环境下可以同时又两个进程处于运行态
  - 就绪态(Ready):已经具备运行条件，但由于没有空闲CPU,而暂时不能运行。进程已经拥有了除处理机之外所有需要的资源，一旦获得处理机，即可立即进入运行态开始运行。即：万事俱备，只欠CPU
  - 阻塞态(Waiting/Blocked,又称：等待态):因等待某一事件而暂时不能运行。如等待操作系统分配打印机、等待读磁盘操作的结果，CPU是计算机中最昂贵的部件，为了提高CPU的利用率，需要先将其他进程需要的资源分配到位，才能得到CPU的服务
  
- 另外两种状态

  - 创建态(New又称新建态): 进程正在被创建，操作系统为进程分配资源，初始化PCB
  - 终止态(Terminated又称结束态): 进程正在从系统中撤销，操作系统会回收进程拥有的资源，撤销PCB

#### [进程状态的转换](http://assets.processon.com/chart_image/61f38797e0b34d06c3b6bdcd.png)

  - 阻塞态->就绪态不是进程自身能控制的，是一种被动行为
  - 运行态->阻塞态是一种进程自身做出的主动行为
  - 注：不能由阻塞态直接转换为运行态，也不能由就绪态直接转换为阻塞态（因为进入阻塞态是进程主动请求的，必然需要进程在运行时才能发出这种请求）

## 进程控制

#### 基本概念

- 进程控制的主要功能是对系统中的所有进程实施有效的管理，它具有创建新进程、撤销已有进程、实现进程状态转换等功能
- 简单理解：反正进程控制就是要实现进程状态转换
- 创建进程：需要初始化PCB，分配系统资源

#### [如何实现进程控制](http://assets.processon.com/chart_image/61f38c27e401fd5d513f5102.png)

- 创建态 -> 就绪态：需要修改PCB内容和相应队列
- 就绪态 -> 运行态：需要恢复进程运行环境、修改PCB内容和相应队列
- 运行态 -> 终止态：需要回收进程拥有的资源，撤销PCB
- 运行态 -> 就绪态：(进程切换)需要保存进程运行环境、修改PCB内容和相应队列
- 运行态 -> 阻塞态：需要保存进程运行环境、修改PCB内核相应队列
- 阻塞态 -> 就绪态：需要修改PCB内容和相应队列。如果等待的是资源，则还需为进程分配系统资源

- 用原语实现进程控制。原语的特点是执行期间不允许中断，只能一气呵成。这种不可中断的操作即原子操作。
- 原语采用”关中断指令“和”开中断指令“实现
- 关/开中断指令的权限非常大，是只允许在核心态下执行的特权指令

#### 进程控制相关的原语

- 进程控制会导致进程状态的转换。无论哪个原语，要做的无非三类事情
  - 更新PCB中的信息（如修改进程状态标志、将运行环境保存到PCB、从PCB恢复允许环境）
    1. 所有的进程控制原语一定都会修改进程状态标志
    2. 剥夺当前运行进程的CPU使用权必然需要保存其运行环境
    3. 某进程开始运行前必然要恢复其运行环境
  - 将PCB插入合适的队列
  - 分配、回收资源
- 进程创建
  - 创建原语：申请空白PCB；为新进程分配所需资源；初始化PCB；将PCB插入就绪队列
  - 引起进程创建的事件
    1. 用户登录：分时系统中，用户登录成功，系统为其创建一个新的进程
    2. 作业调度：多道批处理系统中，有新的作业放入内存时，会为其建立一个新的进程
    3. 提供服务：用户想操作系统提出某些请求时，会新建一个进程处理该请求
    4. 应用请求：有用户进程主动请求创建一个子进程
- 进程的终止
  - 撤销原语
    1. 从PCB集合中找到终止进程PCB
    2. 若进程正在运行，立即剥夺CPU,将CPU分配给其他进程
    3. 终止其所有子进程
    4. 将该进程拥有的所有资源归还给父进程或操作系统
    5. 删除PCB
  - 引起进程终止的事件：正常结束；异常结束；外界干预
- 进程的阻塞
  - 阻塞原语
    1. 找到要阻塞的进程对应的PCB
    2. 保护进程运行现场，将PCB状态信息设置为”阻塞态“，暂时停止进程运行
    3. 将PCB插入相应事件的等待队列
  - 引起进程阻塞的事件：需要等待系统分配某种资源；需要等待相互合作的其他进程完成工作
- 进程的唤醒
  - 唤醒原语
    	1. 在事件等待队列中找到PCB
     	2. 将PCB从等待队列移除，设置进程为就绪态
     	3. 将PCB插入就绪队列，等待被调度
  - 引起进程唤醒的事件：等待事件发生
- 阻塞原语唤醒原语必须成对使用。因何事阻塞，就应由何事唤醒
- 进程的切换
  - 切换原语
    	1. 将允许环境信息存入PCB
     	2. PCB移入相应队列
     	3. 选择另一个进程执行，并更新其PCB
     	4. 根据PCB恢复新进程所需的运行环境
  - 引起进程切换的事件
    	1. 当前进程时间片到
     	2. 有更高优先级的进程到达
     	3. 当前进程主动阻塞
     	4. 当前进程终止

## 进程通信

#### 什么是进程通信

- 顾名思义，进程通信就是指进程之间的信息交换
- 进程是分配系统资源的单位（包括内存地址空间），因此各进程拥有的内存地址空间相对独立
- 为了保证安全，一个进程不能直接访问另一个进程的地址空间，但是进程之间的信息交换又是必须实现的

#### 共享存储

- 两个进程对共享空间的访问必须是互斥的（互斥访问通过操作系统提供的工具实现）
- 操作系统只负责提供共享空间和同步互斥工具(如P、V操作)
- 基于数据结构的共享：比如共享空间里只能放一个长度为10的数组。这种共享方式速度慢、限制多，是一种低级通信方式
- 基于存储区的共享：在内存中画出一块共享存储区，数据的形式、存放位置都由进程控制，而不是操作系统。相比之下，这种共享方式速度更快，是一种高级通信方式。

#### 消息传递

- 进程间的数据交换以格式化的消息(Message)为单位。进程通过操作系统提供的”发送消息、接收消息“两个原语进行数据交换
- 消息投包括：发送进程id,接收进程id,消息类型、消息长度等格式化的信息（计算机网络中发送的报文其实就是一种格式化的消息）
- 直接通信方式：消息直接挂到接收进程的消息缓冲队列上
- 间接通信方式：消息要先发送到中间实体（信箱）中，因此也称信箱通信方式。如计网中的电子邮件系统

#### 管道通信

- 管道是指用于连接读写进程的一个共享文件，又名pipe文件。其实就是在内存中开辟一个大小固定的缓冲区
- 管道只能采用半双工通信，某一时间段内只能实现单向的传输。如果要实现双向同时通信，则需要设置两个管道
- 各进程要互斥地访问管道 
- 数据以字符流的形式写入管道，当管道写满时，写进程write()系统调用将被阻塞，等待读进程将数据取走。当读进程将数据全部取走后，管道变空，此时读进程的read()系统调用将被阻塞
- 如果没写满，就不允许读。如果没读空，就不允许写
- 数据一旦被读出，就从管道中被抛弃，这就意味着读进程最多只能有一个，否则可能会有读错数据的情况

