# 概念

- tcpdump是一款强大的网络抓包工具，它使用libpcap库来抓取网络数据包

# 基本语法和使用方法

```bash
$ sudo tcpdump -i eth0 -nn -s0 -v port 80
```

- -i: 选择要捕获的接口，通常是以太网网卡或无线网卡，也可以是vlan或其他特殊接口。如果该系统只有一个网络接口，则无需指定
- -nn: 单个n表示不解析域名，直接显示ip（默认是用hostname显示）; 两个n表示不解析域名和端口。这样不仅方便查看IP和端口号，而且在抓取大量数据时非常高效，因为域名解析会降低抓取速度
- -s0: tcpdump默认只会截取前96字节的内容，要想截取所有的报文内容，可以使用 -s number, number就是你要截取的报文字节数，如果是0的话，表示截取报文全部内容
- -v -vv -vvv来显示更多的详细信息，通常会显示更多与特定协议相关的信息
- port 80: 这是一个常见的端口过滤器，表示仅抓取80端口上的流量，通常是HTTP

```bash
$ sudo tcpdump -n -e -c 5 not ip6
```

- -e: 显示链路层信息。默认情况下tcpdump不会显示数据链路层信息，使用-e选项可以显示源和目的MAC地址，以及VLAN tag信息
- -c: 指定要抓取包的数量

## 混杂模式

- -p: 不让网络接口进入混杂模式。默认情况下使用tcpdump抓包时，会让网络接口进入混杂模式。一般计算机网卡都工作在非混杂模式下，此时网络接口只接受来自网络端口的目的地址指向自己的数据。当网络工作在混杂模式下时，网卡将来自接口的所有数据都捕获并交给响应的驱动程序。如果设备接入的交换机开启了混杂模式，使用-p选项可以有效的过滤噪声

## 显示ASCII字符串

```bash
$ sudo tcpdump -A -s0 port 80
```

- -A表示使用ASCII字符串打印报文的全部数据，这样可以使读取更加简单，方便使用grep等工具解析输入内容。 
- -X 表示同时使用十六进制和ASCII字符串打印报文的全部数，这俩参数不能一起使用

## 抓取特定协议的数据

```bash
$ tcpdump -i eth0 udp
$ tcpdump -i eth0 proto 17
```

- 后面可以跟上协议名称来过滤特定协议的流量。以UDP为例，可以加上参数 udp或proto 17,这两个命令意思相同
- 同理tcp与protocol 6意思相同

## 抓取特定主机的数据

```bash
$ tcpdump -i eth0 host 10.10.1.1
```

- 使用过滤器host可以抓取特定目的地址和源IP地址的流量

```bash
$ tcpdump -i eth0 dst 10.10.1.20
$ tcpdump -i eth0 src 10.10.1.10
```

- 也可以使用src或dst只抓取源或目的IP

## 抓取数据写入文件

- 使用tcpdump截取数据报文的时候，默认会打印到屏幕的默认输出，-w选项可以把数据报文输出到文件

```bash
$ tcpdump -i eth0 -s0 -w test.pcap
```

## 行缓冲模式

- 如果想实时将抓取到的数据通过管道传递给其他工具来处理，需要使用-l选项来开启行缓冲模式。-l选项可以将输出通过立即发送给其他命令，其他命令会立即响应

```bash
$ tcpdump -i eth0 -s0 -l port 80 | grep 'Server:'
```

## 组合过滤器

```bash
and or &&
or or ||
not or !
```

# 过滤器

