## 初识文件管理

#### 文件的属性

- 文件名：由创建文件的用户决定文件名，主要是危露方便用户找到文件，同一目录下不允许有重名文件
- 标识符：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称
- 类型：指明文件的类型
- 位置：文件存放的路径（让用户使用）、在外存中的地址（操作系统使用，对用户不可见）
- 大小：指明文件大小
- 创建时间，修改时间
- 文件所有者信息
- 保护信息：对文件进行保护的访问控制信息

#### 文件内部的数据应该怎样组织起来

- 无结构文件（如文本文件）-- 由一些二进制或字符流组成，又称”流式文件“
- 有结构文件（如数据库表） -- 由一组相似的记录组成，又称”记录式文件“
  - 数据项是文件系统中最基本的单位
  - 记录是一组相关数据项的集合
  - 有结构文件中，各个记录间应该如何组织的问题--应该顺序存放？还是用索引表来表示记录间的顺序？这是”文件的逻辑结构“重点要探讨的问题

#### 操作系统应该向上提供哪些功能

- 创建文件(create系统调用)
- 删除文件(delete系统调用)
- 读文件(read系统调用)
- 写文件(write系统调用)
- 打开文件(open系统调用)
- 关闭文件(close系统调用)

#### 从上往下看，文件应如何存放在外存

- 操作系统以块为单位为文件分配存储空间，因此即使一个文件大小只有10B,但它依然需要占用1KB的磁盘块(假设块大小为1KB)。外存中的数据读入内存同样以块为单位
- 类似于内存分为一个个内存块，外存会分为一个个”块/磁盘/物理块“。每个磁盘块的大小是相等的，每块一般包含2的整数幂个地址。同样类似的是，文件的逻辑地址也可以分为（逻辑块号，块内地址），操作系统同样需要将逻辑地址转换为外存的物理地址（物理块号，块内地址）的形式。块内地址的位数取决于磁盘块的大小
- 与内存单元一样，外存也是又一个个存储单元组成的，每个存储单元可以存储一定量的数据。每个存储单元对应一个物理地址

## 结构文件

#### 顺序文件

- 串结构：记录顺序与关键字无关
- 顺序结构：记录按关键字排列
- 可变长记录的顺序文件无法实现随机存取，定长记录可以
- 定长记录、顺序结构的顺序文件可以快速检索（根据关键字快速找到记录）
- 最大缺点：不方便增加、删除记录

#### 索引文件

- 建立一张索引表，每个记录对应一个表项。各记录不用保持顺序，方便增加、删除记录
- 索引表本身就是定长记录的顺序文件，一个索引表项就是一条定长记录，因此索引文件可支持随机存取
- 若索引表按关键字排列，则可支持快速检索
- 解决了顺序文件不方便增、删记录的问题，同时让不定长记录的文件实现了随机存取。但索引表可能占用很多空间

#### 索引顺序文件

- 将记录分组，每组对应一个索引表项
- 检索记录时先顺序查索引表，找到分组，再顺序查找分组
- 当记录过多时，可建立多级索引表

## 文件目录

#### 文件目录的实现

- 一个文件对应一个FCB,一个FCB就是一个目录项，多个FCB组成文件目录
- 对目录的操作：搜索，创建文件，删除文件，显示文件，修改文件

#### 目录结构

- 单级目录结构：一个系统只有一张目录表，不允许文件重名
- 两级目录结构：不同用户的文件可以重名，但不能对文件进行分类
- 多级（树形）目录结构
  - 不同目录下的文件可以重名，可以对文件进行分类，不方便文件共享
  - 系统根据”文件路径“找到目标文件
  - 从根目录出发的路径是”绝对路径“
  - 从”当前目录“出发的是路径是”相对路径“
- 无环图目录结构
  - 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录成为一个有向无环图
  - 为共享结点设置一个共享计数器，计数器为0时才真正删除该节点

#### 索引结点

- 除了文件名之外的所有信息都放到索引结点中，每个文件对应一个索引结点
- 目录项中只包含文件名、索引结点指针，因此每个目录项的长度大幅减少
- 由于目录项长度减少，因此每个磁盘块可以存放更多个目录项，因此检索文件时磁盘IO的次数就少了很多

## 文件分配方式

#### 文件块、磁盘块

- 类似于内存分页，磁盘中的存储单元也会被分为一个个”块、磁盘块、物理块“。很多操作系统中，磁盘块的大小与内存块、页面的大小相同
- 内存与磁盘之间的数据交换（即读写操作、磁盘IO）都是以”块“为单位进行的。即每次读入一块，或每次写入一块
- 在内存管理中，进程的逻辑地址空间被分为一个一个页面。同样的，在外存管理中，为了方便对文件数据的管理，文件的逻辑地址空间被分为了一个一个的文件”块“。于是文件的逻辑地址也可以表示为（逻辑块号，块内地址）的形式
- 操作系统为文件分配存储空间都是以块为单位的
- 用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射

#### 连续分配

- 连续分配方式要求每个文件再磁盘上占有一组连续的块
- 优点：支持顺序访问和直接访问（即随机访问）；连续分配的文件再顺序访问上时速度最快
- 缺点：不方便文件扩展；存储空间利用率低，会产生磁盘碎片

#### 链接分配-隐式链接

- 目录中记录了文件存放的起始块号和结束块号。当然，也可以增加一个字段来表示文件的长度
- 除了文件最后一个磁盘块之外，每个磁盘块中都会保存下一个盘块的指针，这些指针对用户是透明的。文件目录包括文件第一块的指针和最后一块指针
- 优点：很方便文件拓展，不会有碎片问题，外存利用率高
- 缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要消耗少量的存储空间

#### 链接分配-显示链接

- 把用于链接文件各物理块的指针显示的存放在一张表中。即文件分配表（FAT, File Allocation Table）
- 注意：一个磁盘仅设置一张FAT。开机时，将FAT读入内存，并常驻内存。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此”物理块号“字段可以是隐含的
- 优点：很方便文件拓展，不会有碎片问题，外存利用率高，并且支持随机访问。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件的访问效率更高
- 缺点：文件分配表需要占用一定的存储空间

#### 索引分配

- 索引分配允许文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块（索引表的功能类似于内存管理中的页表--建立逻辑页面到物理页直接的映射关系）。索引表存放的磁盘块称为索引块。文件数据存放的磁盘块称为数据块
- 假设某个新创建的文件“aaa”的数据依次存放在磁盘块2->5->13->9.7号磁盘块作为“aaa”的索引块，索引块中保存了索引表的内容
- 注：在显示链接的链式分配方式中，文件分配表FAT是一个磁盘对应一张。而索引分配方式中，索引表是一个文件对应一张
- 可以用固定的长度表示物理块号（如：假设磁盘总容量为$1TB=2^{40}B$,磁盘块大小为1KB，则共有$2^{30}$个磁盘块，则可用4B表示磁盘块号），因此索引表中的“逻辑块号”可以是隐含的
- 如何实现文件的逻辑块号到物理块号的转换？
  - 用户给出要访问的逻辑块号i,操作系统找到该文件对应的目录项（FCB）...
  - 从目录项中可知索引表存放位置，将索引表从外存读入内存，并查找索引表即可知i号逻辑块在外存中存放位置
  - 可见，索引分配方式可以支持随机访问。文件拓展也很容易实现（只需要给文件分配一个空闲块，并增加一个索引表项即可）但是索引表需要占用一定的存储空间
- 若每个磁盘块1KB,一个索引表项4B,则一个磁盘块只能存放256个索引项。如果一个文件的大小超过了256块，那么一个磁盘块是装不下文件的整张索引表的，如何解决这个问题？
- 链接方案
  - 如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放
  - 假设磁盘块大小为1KB,一个索引表项占4B,则一个磁盘块只能存放256个索引项。若一个文件大小为$256*256KB=65526KB=64MB$。该文件共有$256*256$个索引项，也就需要256个索引块来存储，这些索引块用链接方案连起来
  - 若想要访问文件的最后一个逻辑块，就必须找到最后一个索引块（第256个索引块），而各个索引块之间是用指针链接起来的，因此必须先顺序的读入前255个索引块。这显然是低效的。如何解决呢？
- 多层索引
  - 建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层，第四层索引块
  - 若采用多层索引，则各层索引表大小不能超过一个磁盘块
  - 假设磁盘块大小为1KB,一个索引表项占4B,则一个磁盘块只能存放256个索引项。若一个文件大小为$256*256KB=65526KB=64MB$。
  - 可根据逻辑块号算出应该查找索引表中的哪个表项。如：要访问1026号块逻辑块，则1026/256=4, 1026%256=2
  - 因此可以先将一级索引表调入内存，查询4号表项，将其对应的二级索引表调入内存，再查询二级索引表的2号表项即可知道1026号逻辑块存放的磁盘块号了。访问目标数据块，需要3次磁盘IO
  - 若采用三层索引，则文件的最大长度为$256*256*256*1KB=16GB$,类似的，访问目标数据块，需要4次磁盘IO
- 混合索引
  - 多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表），还包含两级间接索引（指向两层索引表）。
  - 对于小文件，只需较少的读磁盘次数就可以访问目标数据块。（一般计算机中小文件更多）



## 文件存储空间管理

#### 存储空间的划分与初始化

- 存储空间的划分：将物理磁盘划分为一个个文件卷（逻辑卷、逻辑盘）

- 存储空间的初始化：将各个文件卷划分为目录区、文件区

- 目录区主要存放文件目录信息(FCB)，用于磁盘存储空间管理的信息

- 文件区用于存放文件数据

- 有的系统支持超大型文件，可支持由多个物理磁盘组成一个文件卷

#### 存储空间管理--空闲表法

- 适用于“连续分配方式”

- 如何分配磁盘块：与内存管理中的动态分区分配很类似，为一个文件分配连续的存储空间。同样可采用首次适应、最佳适应、最坏适应等算法来决定要为文件分配哪个区间。

- 如何回收磁盘块：与内存管理中的动态分区分配很类似，当回收某个存储区时需要有四种情况
  
  - ①回收区的前后都没有相邻空闲区
  
  - ②回收区的前后都是空闲区
  
  - ③回收区前面是空闲区
  
  - ④回收区后面是空闲区
  
  - 总之，回收时需要注意表项的合并问题

#### 存储空间管理--空闲链表法

- 空闲盘块链：以盘块为单位组成一条空闲链。空闲盘块中存储着下一个空闲盘块的指针

- 空闲盘区链：以盘区为单位组成一条空闲链。空闲盘区中的第一个盘块内记录了盘区的长度，下一个盘区的指针。连续的空闲盘块组成一个空闲盘区

- 如何分配：若某文件申请K个盘块，则可以采用首次适应，最佳适应等算法，从链头开始检索，按照算法规则找到一个大小负荷要求的空闲盘区，分配给文件。若没有合适的连续空闲块，也可以将不同盘区的盘块同时分配给一个文件，注意分配后可能要修改相应的链指针，盘区大学等数据

- 如何回收：若回收区和某个空闲盘区相邻，则需要将回收区合并到空闲盘区中。若回收区没有和任何空闲区相邻，将回收区作为单独的一个空闲盘区挂到链尾。离散分配、连续分配都适用。为一个文件分配多个盘块时效率更高

#### 存储空间管理--位示图法

- 位示图：每个二进制位对应一个盘块。0代表盘块空闲，1代表盘块已分配。位示图一般用连续的“字”来表示。

- 如何分配：若文件需要K个块，①顺序扫描位示图，找到K个相邻或不相邻的0，②根据字号、位号算出对应的盘块号，将相应盘块分配给文件；③将相应位设置为1

- 如何回收：①根据回收的盘块号计算出对应的字号、位号；②将相应二进制位设为0

#### 存储空间管理--成组链接法

- 空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。UNIX系统中采用了成组链接法对磁盘空闲块进行管理

- 文件卷的目录区中专门用一个磁盘块作为超级块，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的超级块数据一致



## 文件的基本操作

- 创建文件：分配外存空间，创建目录项

- 删除文件：回收外存空间，删除目录项

- 打开文件
  
  - 将目录项中的信息复制到内存中的打开文件表，并将打开文件表的索引号返回给用户。打开文件时并不会吧文件数据直接读入内存。索引号也称文件描述符
  
  - 打开文件之后，对文件的操作不再需要每次都查询目录，可以根据内存中的打开文件表进行操作
  
  - 每个进程有自己的打开文件表，系统中也有一张总的打开文件表
  
  - 进程打开文件表中特有的数学：读写指针，访问权限
  
  - 系统打开文件表中特有的数学：打开计数器（有多少个进程打开了该文件）

- 关闭文件：
  
  -  将进程打开文件表中的相应表项删除
  
  - 系统打开文件表的打开计数器减1，若打开计数器为0，则删除系统表的表项

- 读文件：根据读指针、读入数据量、内存位置将文件数据从外存读入内存。读写文件用文件描述符即可指明文件，不在需要用到文件名

- 写文件：根据写指针、写出数据量、内存位置将文件数据从内存写出外存



## 文件共享

- 操作系统为用户提供文件共享功能，可以让多个用户共享的使用同一个文件

#### 硬连接

- 基于索引结点的共享方式

- 索引结点是一种文件目录瘦身策略。由于检索文件时只需用到文件名，因此可以将除了文件名之外的其他信息放到索引结点中。这样目录项就只需要包含文件名、索引结点指针

- 索引结点中设置一个链接计数变量count,用于表示链接到本索引结点上的用户目录项数

#### 软连接

- 基于符号链的共享方式

- Link类型的文件，记录了文件的存放路径。类似于Windows操作系统的快捷方式



## 文件保护

#### 口令保护

- 为文件设置一个口令，用户请求访问该文件时必须提供口令。口令一般存放在文件对应的FCB或索引结点中，用户访问文件前需要先输入口令，操作系统会将用户提供的口令与FCB中存储的口令进行对比，如果正确，则允许该用户访问文件

- 优点：保存口令的空间开销不多，验证口令的时间开销也很小

- 缺点：正确的口令存放在系统内部，不够安全

#### 加密保护

- 使用某个密码对文件进行加密，在访问文件时需要提供正确的密码才能对文件进行正确的解密

- 优点：保密性强，不需要在系统中存储密码

- 缺点：编码，译码，或者说加密，解密需要花费一定时间

#### 访问控制

- 每个文件的FCB(或索引结点)中增加一个访问控制列表(Access-Control List, ACL),该表中记录了各个用户可以对该文件执行哪些操作



## 文件系统的层次结构

#### 用户接口

- 文件系统需要向上层的用户提供一些简单易用的功能接口。这层就是用于处理用户发出的系统调用请求(Read,Write,Open,Close等系统调用)

#### 文件目录系统

- 用户是通过文件路径来访问文件的，因此这一层需要根据用户给出的文件路径找到相应的FCB或索引结点。所有和目录、目录项相关的管理工作都在本层完成。如：管理活跃的文件目录表，管理打开文件表等

#### 存取控制模块

- 危露保证文件数据的安全，还需要验证用户是否有访问权限。这一层主要完成了文件保护相关功能

#### 逻辑文件系统与文件信息缓冲区

- 用户指明想要访问文件记录号，这一层需要将记录号转换为对应的逻辑地址

#### 物理文件系统

- 这一层需要把上一层提供的文件逻辑地址转换为实际的物理地址

- 辅助分配模块：负责文件存储空间的管理，即负责分配和回收存储空间

- 设备管理模块：直接与硬件交互，负责和硬件直接相关的一些管理工作。如：分配设备，分配设备缓冲区，磁盘调度，启动设备，释放设备等。

#### 总结

- 用一个例子来辅助记忆文件系统的层次结构。假设某用户请求删除文件"D:/工作目录/学生信息.xlsx"的最后100条记录

- ①用户需要通过操作系统提供的接口发出上述请求--用户接口

- ②由于用户提供的是文件的存放路径，因此需要操作系统一层一层的查找目录，找到对应的目录项--文件目录系统

- ③不同的用户对文件有不同的操作权限，因此为了保证安全，需要检查用户是否有访问权限--存取控制模块（存取控制验证层）

- ④验证了用户的访问权限之后，需要把用户提供的记录号转变为对应的逻辑地址--逻辑文件系统与文件信息缓冲区

- ⑤知道了目标记录对应的逻辑地址后，还需要转换成实际的物理地址--物理文件系统

- ⑥要删除这条记录，必定要对磁盘设备发出请求--设备管理程序模块

- 7️⃣删除这些记录后，会有一些盘块空闲，因此要将这些空闲盘块回收--辅助分配模块




