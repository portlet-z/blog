## IO设备的基本概念和分类

#### 什么是IO设备

- IO就是输入输出"Input/Output"

- IO设备就是可以将数据输入到计算机，或者可以接收计算机输出数据的外部设备，属于计算机中的硬件部件。

- UNIX系统将外部设备抽象为一种特殊的文件，用户可以使用与文件操作相同的方式对外部设备进行操作

#### IO设备分类

- 按使用特性
  
  - 人机交互外部设备：数据传输速度慢
  
  - 存储设备：数据传输速度快
  
  - 网络通信设备：数据传输速度介于上述二者之间

- 按传输速率分类
  
  - 低速设备
  
  - 中速设备
  
  - 高速设备

- 按信息交换的单位分类
  
  - 块设备：传输速率较高，可寻址，即对它可随机的读写任一块
  
  - 字符设备：传输速率较慢，不可寻址，在输入输出时常采用中断驱动方式

## IO控制器

#### IO设备的机械部件

- IO设备的机械部件主要用来执行具体IO操作。如我们看得见摸得着的鼠标、键盘的按钮；显示器的LED屏；移动硬盘的磁臂、磁盘盘面

- IO设备的电子部件通常是一块插入主板扩充槽的印刷电路板

#### IO设备的电子部件(IO控制器)

- CPU无法直接控制IO设备的机械部件，因此IO设备还要有一个电子部件作为CPU和IO设备机械部件之间的中介，用于实现CPU对设备的控制

- 这个电子部件就是IO控制器，又称设备控制器。CPU可控制IO控制器，又由IO控制器来控制设备的机械部件

- IO控制器的功能
  
  - 接受和识别CPU发出的命令：如CPU发来的read/write命令，IO控制器中会有相应的控制寄存器来存放命令和参数
  
  - 向CPU报告设备的状态：IO控制器中会有相应的状态寄存器，用于记录IO设备的当前状态。如：1表示空闲，0表示忙碌
  
  - 数据交换：IO控制器中会设置相应的数据寄存器。输出时，数据寄存器用于暂存CPU发来的数据，之后再由控制器传送设备。输入时，数据寄存器用于暂存设备发来的数据，之后CPU从数据寄存器中取走数据
  
  - 地址识别：类似于内存的地址，为了区分设备控制器中的各个寄存器，也需要给各个寄存器设置一个特定的地址，IO控制器通过CPU提供的地址来判断CPU要读写的是哪个寄存器

#### [IO控制器的组成](http://assets.processon.com/chart_image/621de5bb7d9c087b4cc643d2.png)

- CPU与控制器接口：用于实现CPU与控制器之间的通信。CPU通过控制线发出命令；通过地址线指明要操作的社保；通过数据线来取出(输入)数据，或放入(输出)数据

- IO逻辑：负责接收和识别CPU的各种命令(如地址译码)，并负责对设备发出命令

- 控制器与设备的接口：用于实现控制器与设备之间的通信

- 注：①一个IO控制器可能会对应多个设备；②数据寄存器，控制寄存器，状态寄存器可能有多个(如：每个控制、状态寄存器对应 一个具体的设备)，且这些寄存器都要有相应的地址，才能方便CPU操作。有的计算机会让这些寄存器占用内存地址的一部分，称为内存映像IO;另一些计算机则采用IO专用地址，即寄存器独立编址

- 内存映像IO
  
  - 控制器中的寄存器与内存地址统一编址
  
  - 优点：简化了指令。可以采用对内存进行操作的指令来对控制器进行操作

- 寄存器独立编址
  
  - 控制器中的寄存器使用单独的地址
  
  - 缺点：需要设置专门的指令来实现对控制器的操作，不仅要指明寄存器的地址，还要指明控制的编号

## IO控制方式

#### 程序之间控制方式

- ①CPU向控制器发出读指令。于是设备启动，并且状态寄存器设为1（未就绪）

- ②轮询检查控制器的状态（其实就是在不断的执行程序的循环，若状态位一直是1，说明设备还没准备好要输入的数据，于是CPU会不断的轮询）

- ③输入设备准备好数据后将数据传送给控制器，并报告自身状态

- ④控制器将输入的数据放到数据寄存器中，并将状态改为0（已就绪）

- ⑤CPU发现设备已就绪，即可将数据寄存器中的内存读入CPU的寄存器中，再把寄存器中的内容放入内存

- ⑥若还要继续读入数据，则CPU继续发出读指令

#### 中断驱动方式

- 引入中断机制。由于IO设备速度很慢，因此在CPU发出读写命令后，可将等待IO的进程阻塞，先切换到别的进程执行。当IO完成后，控制器会向CPU发出一个中断信号，CPU检测到中断信号后，会保存当前进程的运行环境信息，转去执行中断处理程序处理该中断。处理中断的过程中，CPU从IO控制器读一个字的数据传送到CPU寄存器，再写入主存。接着，CPU恢复等待IO的进程(或其他进程)运行环境，然后继续执行

- 注意：①CPU会在每个指令周期的末尾检查中断；②中断处理过程中需要保存，恢复进程的运行环境，这个过程是需要一定时间开销的。可见，如果中断发生的频率太高，也会降低系统性能

- CPU干预频率：每次IO操作开始之前，完成之后需要CPU介入。等待IO完成的过程中CPU可以切换到别的进程执行

- 数据传送的单位：每次读写一个字

- 数据的流向：读操作(数据输入)：IO设备->CPU->内存。写操作(数据输出)：内存->CPU->IO设备

- 优点：与程序之间控制方式相比，在中断驱动方式中，IO控制器会通过中断信号主动报告IO已完成，CPU不再需要不停的轮询

- 缺点：每个字在IO设备与内存之间的传输，都需要经过CPU.而频繁的中断处理会消耗较多的CPU时间

#### DMA方式

- 与中断驱动方式相比，DMA方式(Direct Memory Access,直接存储器存取)。主要用于块设备的IO控制有这样几个改进

- ①数据的传送单位是块。不再是一个字一个字的传送

- ②数据的流向是从设备直接放入内存，或者从内存直接到设备。不再需要CPU作为快递小哥。

- ③仅在传送一个或多个数据块的开始和结束时，才需要CPU干预

- CPU指明此次要进行的操作(如：读操作)，并说明要读入多少数据，数据要存放在内存的什么位置，数据在外部设备上的地址（如：在磁盘上的地址）

- 控制器会根据CPU提出的要求完成数据的读写工作，整块数据的传输完成后，才向CPU发出中断信号

- DR(Data Register,数据寄存器)：暂存从设备到内存，或从内存到设备的数据

- MAR(Memory Address Register,内存地址寄存器)：在输入时，MAR表示数据应放到内存中的什么位置；输出时MAR表示要输出的数据放在内存中的什么位置

- DC(Data Counter,数据计数器)：表示剩余要读写的字节数

- CR(Command Register,命令、状态寄存器)：用于存放CPU发来的IO命令，或设备的状态信息

- CPU干预频率：仅在传送一个或多个数据块的开始和结束时，才需要CPU干预

- 数据传送的单位：每次读写一个或多个块（注意：每次读写的只能是连续的多个块，且这些块读入内存后在内存中也必须是连续的）

- 数据的流向（不再需要经过CPU）:读操作（数据输入）：IO设备->内存；写操作（数据输出）：内存->IO设备

- 优点：数据传输以块为单位，CPU介入品类进一步降低。数据的传输不再需要先经过CPU再写入内存，数据传输频率进一步增加。CPU和IO设备的并行性得到提升

- 缺点：CPU每发出一条IO指令，只能读写一个或多个连续的数据块。如果要读写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU要分别发出多条IO指令，进行多次中断处理才能完成

#### 通道控制方式

- 通道：一种硬件，可以理解为是”弱鸡版的CPU“。通道可以识别并执行一系列通道指令

- 与CPU相比，通道可以执行的指令很单一，并且通道程序是放在主机内存中的，也就是说通道与CPU共享内存

- ①CPU向通道发出IO指令。指明通道程序在内存中的位置，并指明要操作的是哪个IO设备，之后CPU就切换到其他进程执行了

- ②通道执行内存中的通道程序（其指明了要读入写出多少数据，读写的数据应放在内存的什么位置等信息）

- CPU干预频率：极低，通道会根据CPU的指示执行相应的通道程序，只有完成一组数据块的读写后才需要发出中断信号，请求CPU干预

- 数据传送的单位：每次读写一组数据块

- 数据的流向(在通道的控制下执行)：读操作(数据输入)：IO设备->内存；写操作(数据输入)：内存->IO设备

- 缺点：实现复杂，需要专门的通道硬件支持

- 优点：CPU，通道，IO设备可并行工作，资源利用率很高



## 假脱机技术(SPOOLing技术)

#### 什么是脱机技术

- 批处理阶段引入了脱机输入输出技术(用磁带完成)：引入脱机技术后，缓解了CPU与慢速IO设备的速度矛盾。另一方面，即使CPU在忙碌，也可以提前将数据输入到磁带；即使慢速的输出设备正在忙碌，也可以提前将数据输出到磁带

- 在外围控制机的控制下，慢速输入设备的数据先被输入到更快速的磁带上。之后主机可以从快速的磁带上读入数据，从而缓解了速度矛盾

- 为什么称为脱机--脱离主机的控制进行的输入输出操作

#### 输入井和输出井

- 输入井：模拟脱机输入时的磁带，用于收容IO设备输入的数据

- 输出井：模拟脱机输出时的磁带，用于收容用户进程输出的数据
