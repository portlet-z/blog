## 磁盘的结构

#### 磁盘、磁道、扇区的概念

- 磁盘：磁盘的表面由一些磁性物质组成，可以用这些磁性物质来记录二进制数据

- 磁盘的盘面被划分成一个个磁道。这样的一个圈就是一个磁道

- 最内侧磁道上的扇区面积最小，因此数据密度最大

- 一个磁道又被划分成一个个扇区，每个扇区就是一个磁盘块。各个扇区存放的数据量相同(如1KB)

#### 如何在磁盘中读写数据

- 磁头移动到目标位置，盘片旋转，对应扇区划过磁道才能完成读写

#### 盘面、柱面的概念

- 磁盘有多个盘片摞起来，每个盘片有两个盘面

- 所有盘面中相对位置相同的磁道组成柱面

- 所有磁头都是连在同一个磁臂上的，因此所有磁头只能共进退

#### 磁盘的物理地址

- 可用(柱面号，盘面号，扇区号)来定位任意一个磁盘块。在文件的物理结构中，我们经常提到文件数据存放在外存中的几号块，这个块号就可以转换成(柱面号，盘面号，扇区号)的地址形式

- 可以根据该地址读取一个块
  
  - ①根据柱面号移动磁臂，让磁头指向指定柱面
  
  - ②激活指定盘面对应的磁头
  
  - ③磁盘旋转的过程中，指定的扇区会从磁头下面划过，这样就完成了对指定扇区的读写

#### 磁盘的分类

- 盘片可以更换的称为可换盘磁盘；盘片不可更换的称为固定盘磁盘

- 磁头可以移动的称为活动头磁盘，磁臂可以来回伸缩来带动磁头定位磁道；磁头不可移动的称为固定头磁盘，这种磁盘中每个磁道有一个磁头

## 磁盘调度算法

#### 一次磁盘读写操作需要的时间

- 寻找时间(寻道时间)$T_s$:在读写数据前，将磁头移动到指定磁道所花的时间

- 启动磁头臂是需要时间的。假设耗时为s

- 移动磁头也是需要时间的。假设磁头匀速移动，每跨越一个磁道耗时为m,总共需要跨越n条磁道。则：寻道时间$T_s = s + m * n$

- 延迟时间$T_R$:通过旋转磁盘，使磁头定位到目标扇区所需要的时间。设磁盘转速为r(单位：转/秒，或转/分)，则平均所需的延迟时间$T_R = (1/2)*(1/r) = 1/2r$

- 1/r 就是转一圈需要的时间。找到目标扇区平均需要转半圈，因此再乘以1/2

- 硬盘的典型转速为5400转/分，或7200转/分

- 传输时间$T_t$:从磁盘读出或向磁盘写入数据所经历的时间。假设磁盘转速为r,此次读写的字节数为b,每个磁道上的字节数为N.则：传输时间$T_t = (1/r)*(b/N) = b/(rN)$

- 每个磁道要可存N字节的数据，因此b字节的数据需要b/N个磁道才能存储。而读写一个磁道所需的时间刚好又是转一圈所需要的时间1/r

- 总的平均存取时间$T_a = T_s + 1/2r + b/(rN)$

#### 先来先服务算法(FCFS)

- 根据进程请求访问磁盘的先后顺序进行调度
- 优点：公平，如果请求访问的磁道比较集中的话，算法性能还算过得去
- 缺点：如果有大量进程竞争使用磁盘，请求访问的磁道很分散，则FCFS在性能上很差，寻道时间长。

#### 最短寻找时间优先(SSTF)

- SSTF算法会优先处理的磁道是与当前磁头最近的磁道。可以保证每次的寻道时间最短，但是并不能保证总的寻道时间最短(其实就是贪心算法的思想，只是选择眼前最优，但是总体未必最优)

- 优点：性能较好，平均寻道时间短

- 缺点：可能产生饥饿现象。产生饥饿的原因在于：磁头在一个小区域内来回来去的移动

#### 扫描算法(SCAN)

- SSTF算法会产生饥饿的原因在于：磁头有可能在一个小区域内来回来去的移动。为了防止这个问题，可以规定，只有磁头移动到最外侧磁道的时候才能往内移动，移动到最内侧磁道的时候才能往外移动。这就是扫描算法(SCAN)的思想。由于磁头移动的方式很像电梯，因此也叫电梯算法

- 优点：性能较好，平均寻道时间较短，不会产生饥饿现象

- 缺点：①只有到达嘴边上的磁道时才能改变磁头移动方向②SCAN算法对于各个位置磁道的响应频率不平均

#### LOOK调度算法

- 扫描算法(SCAN)中，只有到达最边上的磁道时才能改变磁头移动方向。如果在磁头移动方向上已经没有别的请求，就可以立即改变磁头移动方向(边移动边观察，因此交LOOK)

- 优点：比起SCAN算法来，不需要每次都移动到最外侧或最内侧才改变磁头方向，使寻道时间进一步缩短

#### 循环扫描算法(C-SCAN)

- SCAN算法对于各个位置磁道的响应频率不平均，而C-SCAN算法就是为了解决这个问题。规定只有磁头朝某个特定方向移动时才处理磁道访问请求，而返回时直接快速移动至起始端而不处理任何请求

- 优点：比起SCAN来，对于各个位置磁道的响应频率很平均

- 缺点：只有到达最边上的磁道时才能改变磁头移动方向。另外比起SCAN算法来，平均寻道时间更长

#### C-LOOK调度算法

- C-SCAN算法的主要缺点是只有到达最边上的磁道时才能改变磁头移动方向，并且磁头返回时不一定需要返回到最边缘的磁道上。C-LOOK算法就是为了解决这个问题。如果磁头移动的方向上已经没有磁道访问请求了，就可以立即让磁头返回，并且磁头只需要返回到有磁道访问请求的位置即可

- 优点：比起C-SCAN算法来，不需要每次都移动带最外侧或最内侧才改变磁头方向，使寻道时间进一步缩短。



## 减少延迟时间的方法

#### 交替编号

- 若采用交替编号的策略，即让逻辑上相邻的扇区在物理上有一定的间隔，可以使读取连续的逻辑扇区所需要的延迟时间更小

#### 错位命名



## 磁盘的管理

#### 磁盘初始化

- ①进行地基格式化（物理格式化），将磁盘的各个磁道划分为扇区。一个扇区通常可分为头、数据区域、尾三个部分组成。管理扇区所需要的各种数据结构一般存放在头、尾两个部分，包括扇区校验码（如奇偶校验、CRC循环冗余校验码等，校验码用于校验扇区中的数据是否发生错误）

- ②将磁盘分区，每个分区由若干柱面组成（即分为我们熟悉的C盘、D盘）

- ③进行逻辑格式化，创建文件系统。包括创建文件系统的根目录，初始化存储空间管理所用的数据结构(如位示图、空闲分区表)

#### 引导块

- 计算机开机时需要进行一系列初始化工作，这些初始化工作是通过执行初始化程序（自举程序）完成的

- 初始化程序程序（自举程序）放在ROM中存在什么问题？万一需要更新自举程序，将会很不方便，因为ROM中的数据无法更改。如何解决？

- ROM中只存放很小的“自举装入程序”

- 开机时计算机先允许“自举装入程序”，通过执行该程序就可找到引导块，并将完整的”自举程序“读入内存，完成初始化

- 完成的自举程序放在磁盘的启动块（即引导块、启动分区）上，启动块位于磁盘的固定位置

- 拥有启动分区的磁盘称为启动磁盘或系统磁盘(C盘)

#### 坏块的管理

- 坏了、无法正常使用的扇区就是坏块。这属于硬件故障，操作系统是无法修复的。应该将坏块标记出来，以免错误的使用到它

- 对于简单的磁盘，可以在逻辑格式化时（建立文件系统时）对整个磁盘进行坏块检查，标明哪些扇区是坏扇区，比如：在FAT表上标明(在这种方式中，坏块对操作系统不透明)

- 对于复杂的磁盘，磁盘控制器(磁盘设备内部的一个硬件部件)会维护一个坏块链表

- 在磁盘出厂前进行低级格式化（物理格式化）时就将坏块链进行初始化

- 会保留一些”备用扇区“，用于替换坏块。这种方案称为扇区备用。且这种处理方式中，坏块对操作系统透明
