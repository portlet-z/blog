## ###CPU的组成

- 运算器进行信息处理
- 寄存器进行信息存储
- 控制器协调各种器件进行工作
- 内部总线实现CPU内各个器件之间的联系

## 寄存器是CPU内部的信息存储单元

- 8086CPU有14个寄存器

  - 通用寄存器：AX, BX, CX, DX
  - 变址寄存器：SI, DI
  - 指针寄存器：SP, BP
  - 指令指针寄存器：IP
  - 段寄存器：CS, SS, DS, ES
  - 标志寄存器：PSW
- 共性：8086CPU所有的寄存器都是16位的，可以存放两个字节
- 8086上一代CPU中寄存器都是8位的，如何保证程序的兼容性？通用寄存器均可以分为两个独立的8位寄存器

  - AX可以分为AH, AL 
  - BX可以分为BH, BL 
  - CX可以分为CH, CL 
  - DX可以分为DH, DL
- 8086是16位CPU, 8086的字长(word size)为16bit

## mov和add指令

- 汇编指令不区分大小写

| 汇编指令    | 控制CPU完成的操作                  | 用高级语言的语法描述 |
| ----------- | ---------------------------------- | -------------------- |
| mov ax, 18H | 将18送入ax                         | ax = 18              |
| mov ah, 78H | 将78送入ah                         | ah = 78              |
| add ax, 8   | 将寄存器ax中的数值加8              | ax = ax + 8          |
| mov ax, bx  | 将寄存器bx中的数据送入寄存器ax     | ax = bx              |
| add ax, bx  | 将ax, bx中的内容相加，结果存入ax中 | ax = ax + bx         |

- 设原ax, bx中的值均为0000H

| 程序段中的指令 | 指令执行后ax中的数据 | 指令执行后bx中的数据 |
| -------------- | -------------------- | -------------------- |
| mov ax, 4e20   | 4e20                 | 0000                 |
| mov ax, 1406H  | 6226H                | 0000H                |
| mov bx, 2000H  | 6226H                | 2000H                |
| add ax, bx     | 8226H                | 2000H                |
| mov bx, ax     | 8226H                | 8226H                |
| add ax, bx     | 044CH                | 8226H                |

- 设原ax, bx中的值均为0000H

| 程序段中的指令 | 执行指令后ax中的数据 | 执行指令后bx中的数据 |
| -------------- | -------------------- | -------------------- |
| mov ax, 001AH  | 001AH                | 0000H                |
| mov bx, 0026H  | 001AH                | 0026H                |
| add al, bl     | 0040H                | 0026H                |
| add ah, bl     | 2640H                | 0026H                |
| add bh, al     | 2640H                | 4026H                |
| mov ah, 0      | 0040H                | 4026H                |
| add al, 85H    | 00C5H                | 4026H                |
| add al, 93H    | 0058H                | 4026H                |

## 确定物理地址的方法

### 物理地址

- CPU访问内存单元时要给出内存单元的地址
- 所有的内存单元构成的存储空间是一个一维的线性空间
- 每一个内存单元在这个空间中都有唯一的地址，这个唯一的地址称为物理地址
- 8086有20位地址总线，可传送20位地址，寻址能力为1M
- 8086是16位结构的CPU
  - 运算器一次最多可以处理16位的数据，寄存器的最大宽度为16位
  - 在8086内部处理的，传输，暂存的地址也是16位，寻址能力也只有64KB
  - 问题：8086如何处理在寻址空间上的这个矛盾？

### 8086CPU给出物理地址的方法

- 用两个16位地址（段地址，偏移地址）合成一个20位的物理地址
- 地址加法器合成物理地址的方法：物理地址 = 段地址 * 16 + 偏移地址
- CPU在访问内存时，用一个基础地址（段地址*16）和一个相对于基础地址的偏移地址相加，给出内存单元的物理地址

## 内存的分段表示法

- 内存并没有分段，段的划分来自于CPU
- 段地址*16必然是16的倍数，所以一个段的起始地址也一定是16的倍数
- 偏移地址为16位，16位地址的寻址能力为64K, 所以一个段的长度最大为64K
- 不用的段地址和偏移地址形成同一个物理地址

| 物理地址 | 段地址 | 偏移地址 |
| -------- | ------ | -------- |
| 21F60H   | 2000H  | 1F60H    |
|          | 2100H  | 0F60H    |
|          | 21F0H  | 0060H    |
|          | 21F6H  | 0000H    |
|          | 1F00H  | 2F60H    |

- 偏移地址16位，变化范围为0000 - FFFFH,用偏移地址最大寻址64KB
- 例：给定段地址2000H, 用偏移地址寻址的范围是： 20000H - 2FFFFH ,共64K
- 数据21F60H内存单元中，段地址是2000H, 说法
  - 数据存在内存2000:1F60单元中
  - 数据存在内存的2000H段中的1F60H单元中
- 段地址很重要==专门的寄存器存放段地址
  - CS:  代码段寄存器
  - DS: 数据段寄存器
  - SS: 栈段寄存器
  - ES: 附加段寄存器

## Debug

- 用R命令查看，改变CPU寄存器的内容
  - R - 查看寄存器内容
  - R 寄存器名 - 改变指定寄存器内容

- 用D命令查看内存中的内容
  - D - 列出预设地址内存储的128个字节内容
  - D 段地址:偏移地址 - 列出内存中指定地址处的内容
  - D 端地址:便宜地址 结尾便宜地址 - 列出内存中指定地址范围内的内容
- 用E命令改变内存中的内容
  - E 段地址：偏移地址 数据1， 数据2，。。。
  - E 段地址: 偏移地址：逐个询问式修改；空格 - 接受，继续；回车-结束

- 用U命令将内存中的机器指令翻译成汇编指
  - e地址 数据-写入
  - d地址 - 查看
  - u地址 - 查看代码

```assembly
mov ax, 0123H
mov bx, 0003H
mov ax, bx
add ax, bx
; 对应的机器码为
; B8 23 01
; BB 03 00
; 89 D8
; 01 D8
```

- 用A命令以汇编指令的格式在内存中写入机器指令
  - a 地址-写入汇编指令
  - d 地址-查看数据
  - u 地址-查看代码
- 用T命令执行机器指令 t - 执行CS:IP处的指令
- q - 退出debug

## CS, IP与代码段

- CS: 代码段寄存器
- IP: 指令指针寄存器
- CS:IP : CPU将内存中CS:IP指向的内容当做指令执行

### 8086PC读取和执行指令的过程

- 从CS:IP指向内存单元读取指令，读取的指令进入指令缓冲区
- IP = IP + 所读取指令的长度，从而指向下一条指令
- 执行指令。转到步骤1，重复这个过程

## jmp指令

### 修改CS, IP的指令

- 执行何处的指令，取决于CS:IP
- 可以通过改变CS, IP中的内容，来控制CPU要执行的目标指令
- 如何改变CS, IP的值
  - Debug中的R命令可以改变寄存器的值：rcs, rip.  Debug是调试手段，并非程序方式
  - 指令修改：mov cs, 2000H 8086不提供对CS和IP修改的指令
  - 转移指令jmp

### 转移指令jmp

- 同时修改CS, IP的内容

```assembly
; jmp 段地址: 偏移地址
jmp 2AE3:3
jmp 2:0B16
; 功能：用指令中给出的段地址修改CS, 偏移地址修改IP
```

- 仅修改IP的内容

```assembly
; jmp 某一合法寄存器
jmp ax ; (类似于mov IP, ax)
jmp bx
; 功能：用寄存器中的值修改IP
```

